<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Track Your Tiffin - TiffinMate</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .calendar-container {
        background-color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .calendar-day-header {
        text-align: center;
        font-weight: 600;
        padding: 1rem 0.5rem;
        color: var(--text-dark);
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        padding: 0.5rem;
      }

      .calendar-day:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow);
      }

      .calendar-day.empty {
        border: none;
        cursor: default;
      }

      .calendar-day.empty:hover {
        transform: none;
        box-shadow: none;
      }

      .calendar-day.delivered {
        background-color: var(--light-green);
        border-color: var(--primary-green);
      }

      .calendar-day.missed {
        background-color: #f8d7da;
        border-color: #dc3545;
      }

      .calendar-day.pending {
        background-color: #fff3cd;
        border-color: #ffc107;
      }

      .calendar-day.future {
        background-color: #f8f9fa;
        border-color: #dee2e6;
      }

      .day-number {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .day-status {
        font-size: 1.5rem;
      }

      .month-nav-btn {
        background-color: var(--primary-green);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .month-nav-btn:hover {
        background-color: var(--dark-green);
      }

      .subscription-selector {
        background-color: white;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
      }

      .summary-box {
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--dark-green)
        );
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .summary-item {
        text-align: center;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
      }

      .summary-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-bottom: 0.5rem;
      }

      .legend {
        display: flex;
        gap: 2rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 2rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .legend-color {
        width: 30px;
        height: 30px;
        border-radius: 6px;
        border: 2px solid #333;
      }

      @media (max-width: 768px) {
        .calendar-day-header {
          font-size: 0.8rem;
          padding: 0.5rem 0.25rem;
        }

        .day-number {
          font-size: 1rem;
        }

        .day-status {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <a href="/" class="logo">
          <span class="logo-icon">üç±</span>
          TiffinMate
        </a>
        <button class="mobile-menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <ul class="nav-links" id="navLinks">
          <li><a href="/">Home</a></li>
          <li><a href="/search">Search Tiffin</a></li>
          <li id="authLinks">
            <a href="/login" class="btn btn-secondary btn-small">Login</a>
          </li>
          <li>
            <a href="/register-vendor" class="btn btn-primary btn-small"
              >List Your Service</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <!-- Header -->
    <section
      style="
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--dark-green)
        );
        color: white;
        padding: 3rem 0;
        text-align: center;
      "
    >
      <div class="container">
        <h1>Track Your Tiffin Deliveries</h1>
        <p>Monitor your daily meal deliveries and manage your subscription</p>
      </div>
    </section>

    <!-- Main Content -->
    <section class="section">
      <div class="container">
        <!-- Subscription Selector -->
        <div class="subscription-selector">
          <div class="form-group">
            <label class="form-label">Select Your Subscription</label>
            <select
              id="subscriptionSelect"
              class="form-select"
              onchange="loadSubscriptionData()"
            >
              <option value="">-- Choose a subscription --</option>
            </select>
          </div>
          <div id="subscriptionInfo" style="display: none; margin-top: 1rem">
            <div class="flex-between flex-wrap gap-2">
              <div><strong>Vendor:</strong> <span id="vendorName"></span></div>
              <div><strong>Plan:</strong> <span id="planType"></span></div>
              <div><strong>Status:</strong> <span id="statusBadge"></span></div>
              <div><strong>Period:</strong> <span id="periodRange"></span></div>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button
                class="btn btn-secondary"
                onclick="toggleSubscriptionStatus()"
              >
                <span id="pauseResumeText">Pause Subscription</span>
              </button>
              <button class="btn btn-outline" onclick="cancelSubscription()">
                Cancel Subscription
              </button>
            </div>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner" style="display: none"></div>

        <!-- Summary Section -->
        <div id="summarySection" style="display: none">
          <div class="summary-box">
            <h2>Monthly Summary</h2>
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-value" id="totalDeliveries">0</span>
                <span>Total Deliveries</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="deliveredCount">0</span>
                <span>Delivered ‚úÖ</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="missedCount">0</span>
                <span>Missed ‚ùå</span>
              </div>
              <div class="summary-item">
                <span class="summary-value" id="pendingCount">0</span>
                <span>Pending ‚è≥</span>
              </div>
            </div>
          </div>

          <!-- Calendar -->
          <div class="calendar-container">
            <div class="calendar-header">
              <button class="month-nav-btn" onclick="changeMonth(-1)">
                ‚Üê Previous
              </button>
              <h2 id="currentMonth">January 2025</h2>
              <button class="month-nav-btn" onclick="changeMonth(1)">
                Next ‚Üí
              </button>
            </div>

            <div class="calendar-grid">
              <div class="calendar-day-header">Sun</div>
              <div class="calendar-day-header">Mon</div>
              <div class="calendar-day-header">Tue</div>
              <div class="calendar-day-header">Wed</div>
              <div class="calendar-day-header">Thu</div>
              <div class="calendar-day-header">Fri</div>
              <div class="calendar-day-header">Sat</div>
            </div>

            <div class="calendar-grid" id="calendarDays"></div>

            <!-- Legend -->
            <div class="legend">
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="
                    background-color: var(--light-green);
                    border-color: var(--primary-green);
                  "
                ></div>
                <span>Delivered ‚úÖ</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background-color: #f8d7da; border-color: #dc3545"
                ></div>
                <span>Missed ‚ùå</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background-color: #fff3cd; border-color: #ffc107"
                ></div>
                <span>Pending ‚è≥</span>
              </div>
              <div class="legend-item">
                <div
                  class="legend-color"
                  style="background-color: #f8f9fa; border-color: #dee2e6"
                ></div>
                <span>Future üìÖ</span>
              </div>
            </div>
          </div>
        </div>

        <!-- No Subscription Message -->
        <div
          id="noSubscription"
          style="display: none; text-align: center; padding: 3rem"
        >
          <div style="font-size: 4rem; margin-bottom: 1rem">üç±</div>
          <h3>No Active Subscriptions</h3>
          <p>You don't have any active tiffin subscriptions yet.</p>
          <a href="/search" class="btn btn-primary btn-large mt-3"
            >Find Tiffin Services</a
          >
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>üç± TiffinMate</h3>
            <p>
              Connecting students and professionals with homely, affordable
              tiffin services.
            </p>
          </div>
          <div class="footer-section">
            <h3>Quick Links</h3>
            <ul class="footer-links">
              <li><a href="/">Home</a></li>
              <li><a href="/search">Search Tiffin</a></li>
              <li><a href="/tracking">Track Delivery</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 TiffinMate. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
      let currentDate = new Date();
      let currentSubscription = null;
      let deliveries = [];
      let stats = {};

      function toggleMenu() {
        document.getElementById("navLinks").classList.toggle("active");
      }

      window.addEventListener("DOMContentLoaded", async () => {
        await loadUserSubscriptions();
      });

      async function loadUserSubscriptions() {
        try {
          // Get logged-in user from session
          const session = JSON.parse(
            localStorage.getItem("userSession") || "null"
          );

          if (!session || session.type !== "user") {
            document.getElementById("noSubscription").innerHTML =
              '<p>Please <a href="/login">login</a> to view your subscriptions.</p>';
            document.getElementById("noSubscription").style.display = "block";
            return;
          }

          const userId = session.userId;
          const response = await fetch(`/api/subscriptions/user/${userId}`);
          const subscriptions = await response.json();

          const select = document.getElementById("subscriptionSelect");

          if (subscriptions.length === 0) {
            document.getElementById("noSubscription").innerHTML =
              '<p>You have no active subscriptions. <a href="/search">Browse tiffin services</a> to get started!</p>';
            document.getElementById("noSubscription").style.display = "block";
            return;
          }

          subscriptions.forEach((sub) => {
            const option = document.createElement("option");
            option.value = sub.id;
            option.textContent = `${sub.vendor_name} - ${sub.plan_type} (${sub.status})`;
            select.appendChild(option);
          });

          // Check if subscription ID is in URL
          const urlParams = new URLSearchParams(window.location.search);
          const subId = urlParams.get("subscription");
          if (subId) {
            select.value = subId;
            await loadSubscriptionData();
          }
        } catch (error) {
          console.error("Error loading subscriptions:", error);
        }
      }

      async function loadSubscriptionData() {
        const subscriptionId =
          document.getElementById("subscriptionSelect").value;

        if (!subscriptionId) {
          document.getElementById("subscriptionInfo").style.display = "none";
          document.getElementById("summarySection").style.display = "none";
          return;
        }

        document.getElementById("loadingSpinner").style.display = "block";

        try {
          // Load subscription details
          const subResponse = await fetch(
            `/api/subscriptions/${subscriptionId}`
          );
          currentSubscription = await subResponse.json();

          // Display subscription info
          document.getElementById("vendorName").textContent =
            currentSubscription.vendor_name;
          document.getElementById("planType").textContent =
            currentSubscription.plan_type;
          document.getElementById("periodRange").textContent = `${new Date(
            currentSubscription.start_date
          ).toLocaleDateString()} - ${new Date(
            currentSubscription.end_date
          ).toLocaleDateString()}`;

          const statusBadge = document.getElementById("statusBadge");
          statusBadge.className = "badge";
          if (currentSubscription.status === "active") {
            statusBadge.className += " badge-success";
            statusBadge.textContent = "‚úì Active";
            document.getElementById("pauseResumeText").textContent =
              "Pause Subscription";
          } else if (currentSubscription.status === "paused") {
            statusBadge.className += " badge-warning";
            statusBadge.textContent = "‚è∏ Paused";
            document.getElementById("pauseResumeText").textContent =
              "Resume Subscription";
          } else {
            statusBadge.className += " badge-danger";
            statusBadge.textContent = "‚úï " + currentSubscription.status;
          }

          document.getElementById("subscriptionInfo").style.display = "block";

          // Load deliveries and stats
          await loadDeliveries();
          await loadStats();

          document.getElementById("loadingSpinner").style.display = "none";
          document.getElementById("summarySection").style.display = "block";
        } catch (error) {
          console.error("Error loading subscription data:", error);
          document.getElementById("loadingSpinner").style.display = "none";
        }
      }

      async function loadDeliveries() {
        const subscriptionId = currentSubscription.id;
        const month = String(currentDate.getMonth() + 1);
        const year = String(currentDate.getFullYear());

        const response = await fetch(
          `/api/deliveries/subscription/${subscriptionId}?month=${month}&year=${year}`
        );
        deliveries = await response.json();

        renderCalendar();
      }

      async function loadStats() {
        const subscriptionId = currentSubscription.id;
        const month = String(currentDate.getMonth() + 1);
        const year = String(currentDate.getFullYear());

        const response = await fetch(
          `/api/deliveries/stats/${subscriptionId}?month=${month}&year=${year}`
        );
        stats = await response.json();

        document.getElementById("totalDeliveries").textContent =
          stats.total_deliveries;
        document.getElementById("deliveredCount").textContent =
          stats.delivered_count;
        document.getElementById("missedCount").textContent = stats.missed_count;
        document.getElementById("pendingCount").textContent =
          stats.pending_count;
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById("currentMonth").textContent = new Date(
          year,
          month,
          1
        ).toLocaleDateString("en-US", { month: "long", year: "numeric" });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const calendarDays = document.getElementById("calendarDays");
        calendarDays.innerHTML = "";

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement("div");
          emptyDay.className = "calendar-day empty";
          calendarDays.appendChild(emptyDay);
        }

        // Days of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const delivery = deliveries.find((d) => d.delivery_date === dateStr);

          const dayCell = document.createElement("div");
          dayCell.className = "calendar-day";

          const currentDateObj = new Date(year, month, day);

          if (delivery) {
            if (delivery.status === "delivered") {
              dayCell.classList.add("delivered");
              dayCell.innerHTML = `<div class="day-number">${day}</div><div class="day-status">‚úÖ</div>`;
            } else if (delivery.status === "missed") {
              dayCell.classList.add("missed");
              dayCell.innerHTML = `<div class="day-number">${day}</div><div class="day-status">‚ùå</div>`;
            } else if (currentDateObj > today) {
              dayCell.classList.add("future");
              dayCell.innerHTML = `<div class="day-number">${day}</div><div class="day-status">üìÖ</div>`;
            } else {
              dayCell.classList.add("pending");
              dayCell.innerHTML = `<div class="day-number">${day}</div><div class="day-status">‚è≥</div>`;
            }

            dayCell.onclick = () => showDeliveryDetails(delivery);
          } else if (currentDateObj > today) {
            dayCell.classList.add("future");
            dayCell.innerHTML = `<div class="day-number">${day}</div>`;
          } else {
            dayCell.innerHTML = `<div class="day-number">${day}</div>`;
          }

          calendarDays.appendChild(dayCell);
        }
      }

      function showDeliveryDetails(delivery) {
        const status =
          delivery.status === "delivered"
            ? "‚úÖ Delivered"
            : delivery.status === "missed"
            ? "‚ùå Missed"
            : "‚è≥ Pending";
        const message = `Date: ${new Date(
          delivery.delivery_date
        ).toLocaleDateString()}\nStatus: ${status}`;

        if (delivery.notes) {
          alert(message + `\nNotes: ${delivery.notes}`);
        } else {
          alert(message);
        }
      }

      async function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        await loadDeliveries();
        await loadStats();
      }

      async function toggleSubscriptionStatus() {
        const newStatus =
          currentSubscription.status === "active" ? "paused" : "active";

        try {
          await fetch(`/api/subscriptions/${currentSubscription.id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus }),
          });

          alert(
            `Subscription ${
              newStatus === "active" ? "resumed" : "paused"
            } successfully!`
          );
          await loadSubscriptionData();
        } catch (error) {
          console.error("Error updating subscription:", error);
          alert("Failed to update subscription");
        }
      }

      async function cancelSubscription() {
        if (!confirm("Are you sure you want to cancel this subscription?")) {
          return;
        }

        try {
          await fetch(`/api/subscriptions/${currentSubscription.id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "cancelled" }),
          });

          alert("Subscription cancelled successfully!");
          window.location.reload();
        } catch (error) {
          console.error("Error cancelling subscription:", error);
          alert("Failed to cancel subscription");
        }
      }

      // Update navigation based on session
      function updateNavigation() {
        const session = JSON.parse(
          localStorage.getItem("userSession") || "null"
        );
        const authLinks = document.getElementById("authLinks");

        if (session) {
          if (session.type === "user") {
            authLinks.innerHTML = `
              <a href="/dashboard">Dashboard</a>
              <a href="/tracking">Track</a>
              <a href="#" onclick="logout()" class="btn btn-secondary btn-small">Logout</a>
            `;
          } else if (session.type === "vendor") {
            authLinks.innerHTML = `
              <a href="/vendor-dashboard">Dashboard</a>
              <a href="#" onclick="logout()" class="btn btn-secondary btn-small">Logout</a>
            `;
          }
        }
      }

      function logout() {
        localStorage.removeItem("userSession");
        window.location.href = "/";
      }

      // Run on page load
      updateNavigation();
    </script>
  </body>
</html>
